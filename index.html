<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OFED - Ozone-depleting Substances & Fluorinated gases Emissions Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        .nav-link.active { border-bottom: 2px solid white; font-weight: bold; }
        .method-box { transition: all 0.3s ease; }
        .method-box:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen font-sans">

    <nav class="bg-blue-900 text-white sticky top-0 z-50 shadow-md">
        <div class="container mx-auto px-4 flex justify-between items-center h-16">
            <div class="flex items-center space-x-2">
                <span class="text-2xl font-bold tracking-tighter cursor-pointer" onclick="showPage('home')">OFED</span>
            </div>
            <div class="hidden lg:flex space-x-6 text-sm uppercase tracking-wide">
                <button onclick="showPage('home')" id="nav-home" class="nav-link py-2 hover:text-blue-300 transition">OFED Introduction</button>
                <button onclick="showPage('inventory')" id="nav-inventory" class="nav-link py-2 hover:text-blue-300 transition">OFED Inventory Emissions</button>
                <button onclick="showPage('inversion')" id="nav-inversion" class="nav-link py-2 hover:text-blue-300 transition">OFED Inversion Emissions</button>
                <button onclick="showPage('comparison')" id="nav-comparison" class="nav-link py-2 hover:text-blue-300 transition">OFED and Other Datasets</button>
                <button onclick="showPage('about')" id="nav-about" class="nav-link py-2 hover:text-blue-300 transition">About Team</button>
            </div>
            <div id="user-status">
                <button onclick="openAuthModal()" class="bg-blue-600 hover:bg-blue-700 px-5 py-2 rounded shadow text-sm font-semibold transition">
                    Login / Register
                </button>
            </div>
        </div>
    </nav>

    <main class="flex-grow">
        <section id="home" class="page active">
            <div class="bg-blue-50 py-6 border-b border-blue-100 text-center px-4">
                <h1 class="text-4xl md:text-5xl font-extrabold text-blue-900 mb-6 max-w-5xl mx-auto">OFED: Ozone-depleting Substances & Fluorinated Gases Emissions Database</h1>
                <p class="text-xl text-gray-700 max-w-4xl mx-auto leading-relaxed">
               The OFED database is derived from the published research findings of 
              <a href="javascript:void(0)" onclick="showPage('about')" class="text-blue-600 hover:text-blue-900 underline-offset-4 transition-colors font-semibold">
                our team</a>. 
               </p>
                <p class="text-xl text-gray-700 max-w-5xl mx-auto leading-relaxed">
                <span class="block">OFED provides emissions data for ozone-depleting substances (ODSs) and fluorinated gases (F-gases)</span>
                <span class="block">to address their dual impact on ozone depletion and climate change.</span>
               </p>
            </div>
            <div class="container mx-auto px-4 py-8">
                <div class="grid md:grid-cols-2 gap-12 mb-8">
                    <div class="bg-white p-8 rounded-xl border-l-4 border-blue-600 shadow-sm">
                        <h2 class="text-2xl font-bold text-blue-900 mb-4">The Montreal Protocol</h2>
                        <p class="text-gray-600">Successfully phased out most ODSs, safeguarding the stratospheric ozone layer for future generations.</p>
                    </div>
                    <div class="bg-white p-8 rounded-xl border-l-4 border-green-600 shadow-sm">
                        <h2 class="text-2xl font-bold text-green-900 mb-4">UN Climate Change Conventions</h2>
                        <p class="text-gray-600">Mandate the reduction of all greenhouse gases, including many F-gases, to mitigate global warming.</p>
                    </div>
                </div>
                <div class="prose max-w-none text-gray-700 space-y-3 text-center">
                    <p class="text-lg leading-relaxed">
        Accurate quantification of atmospheric emissions is the cornerstone of global environmental governance. 
        It transforms invisible chemical releases into actionable scientific insights, empowering researchers 
        and policymakers to monitor mitigation progress with precision. By mapping the trajectory of these 
        substances, we can identify critical emission hotspots, verify international compliance, and develop 
        robust forecast models for future environmental outcomes.
    </p>
    <p class="text-lg leading-relaxed"> 
        OFED serves as a vital strategic bridge, connecting the rigors of scientific measurement with the 
        demands of effective policy-making for planetary health. We consolidate disparate, multi-source data—ranging 
        from high-frequency atmospheric observations to granular industrial reporting—into a single, trusted, 
        open-access resource.
    </p>
                    <div class="text-center pt-6">
                        <span class="text-2xl font-serif italic text-blue-800">"Data for Action. Science for Protection."</span>
                    </div>
                </div>
                <div class="grid md:grid-cols-3 gap-8 mt-12"> <div class="method-box bg-white p-8 rounded-2xl shadow-sm border border-gray-100 cursor-pointer" onclick="showPage('inventory')">
        <span class="text-blue-600 font-bold uppercase tracking-widest text-sm">Explore Results</span>
        <h3 class="text-2xl font-bold mt-2 mb-4">Inventory Emissions</h3>
        <p class="text-gray-500 mb-4">The bottom-up approach quantifies emissions using activity data (production and consumption) and emission factors.</p>
        <span class="text-blue-600 font-semibold inline-flex items-center">View Database &rarr;</span>
    </div>

    <div class="method-box bg-white p-8 rounded-2xl shadow-sm border border-gray-100 cursor-pointer" onclick="showPage('inversion')">
        <span class="text-green-600 font-bold uppercase tracking-widest text-sm">Explore Results</span>
        <h3 class="text-2xl font-bold mt-2 mb-4">Inversion Emissions</h3>
        <p class="text-gray-500 mb-4">The top-down approach quantifies emissions using observations, transport models, and inversion algorithms.</p>
        <span class="text-green-600 font-semibold inline-flex items-center">View Database &rarr;</span>
    </div>

    <div class="method-box bg-white p-8 rounded-2xl shadow-sm border border-gray-100 cursor-pointer" onclick="showPage('comparison')">
        <span class="text-indigo-600 font-bold uppercase tracking-widest text-sm">Cross-Study Comparison</span>
        <h3 class="text-2xl font-bold mt-2 mb-4">OFED and Other Datasets</h3>
        <p class="text-gray-500 mb-4">Comprehensive comparison between OFED results and other established global/regional emission datasets.</p>
        <span class="text-indigo-600 font-semibold inline-flex items-center">Compare Data &rarr;</span>
    </div>
</div>
            </div>
        </section>

<section id="inventory" class="page container mx-auto px-4 py-12">
    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-8">
        <div class="flex justify-between mb-4 border-b pb-3">
            <div>
                <h2 class="text-2xl font-bold text-blue-900">Inventory Emissions Visualization</h2>
                <p class="text-gray-500 text-sm">Provide both total emissions and sectoral breakdowns.</p>
            </div>
            <button onclick="handleDownload('inventory.csv')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                Download Data
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-8">
    <div>
        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Substance</label>
        <select id="substance-select" onchange="handleMainFilterChange()" class="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500">
            <option>CFC-11</option><option>CFC-12</option><option>CFC-113</option><option>HCFC-22</option><option>HCFC-141b</option>
            <option>HCFC-142b</option><option>HFC-134a</option><option>HFC-143a</option><option>HFC-32</option>
            <option>HFC-125</option><option>HFC-152a</option><option>HFC-227ea</option><option>HFC-236fa</option><option>HFC-245fa</option><option>HFC-365mfc</option><option>SF6</option>
            <option>NF3</option><option>CF4</option><option>C2F6</option><option>C3F8</option><option>c-C4F8</option><option>CCl4</option><option>CH3Br</option><option>CH3CCl3</option>
            <option>Halon-1211</option><option>Halon-1301</option>
        </select>
    </div>

    <div>
        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Region</label>
        <select id="region-select" onchange="handleMainFilterChange()" class="w-full border rounded-lg p-2 text-sm">
            <option>China</option>
        </select>
    </div>

    <div>
        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Start Year</label>
        <select id="start-year" class="w-full border rounded-lg p-2 text-sm">
            <option>1980</option>
        </select>
    </div>

    <div>
        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">End Year</label>
        <select id="end-year" class="w-full border rounded-lg p-2 text-sm">
            <option>2024</option>
        </select>
    </div>

    <div class="md:col-span-2 flex items-end space-x-2">
        
        <button id="btn-line" onclick="setActiveButton('btn-line'); updateInventoryChart('line')" 
                class="chart-btn w-24 bg-gray-200 text-gray-800 text-xs font-bold py-2.5 rounded hover:bg-gray-300 transition uppercase whitespace-nowrap">
            Total (Line)
        </button>

        <div id="reference-wrapper" class="flex-1">
            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Source (for Sector)</label>
            <select id="reference-select" class="w-full border rounded-lg p-2 text-sm">
                </select>
        </div>

        <button id="btn-bar" onclick="setActiveButton('btn-bar'); updateInventoryChart('bar')" 
                class="chart-btn w-24 bg-gray-200 text-gray-800 text-xs font-bold py-2.5 rounded hover:bg-gray-300 transition uppercase whitespace-nowrap">
            Sector (Bar)
        </button>
    </div>
</div>

        <div id="inventory-chart" class="w-full h-[500px]" style="width: 100%; height: 500px;"></div>
    </div>

    <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 mb-8">
        <h3 class="text-2xl font-bold text-gray-900 mb-4 border-l-4 border-blue-600 pl-4">Methodology</h3>
        <p class="text-gray-600 leading-relaxed italic">
            The bottom-up inventory approach estimates emissions based on activity data (production and consumption) and emission factors, in accordance with the emission mechanisms specific to each sector. For detailed methodologies, please refer to the publications listed below.
        </p>
    </div>

    <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
        <h3 class="text-xl font-bold text-gray-900 mb-6">Publications</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm border-collapse">
                <thead>
                    <tr class="bg-gray-50 border-b">
                        <th class="p-4 font-bold">Study</th>
                        <th class="p-4 font-bold">Substance</th>
                        <th class="p-4 font-bold">Region</th>
                        <th class="p-4 font-bold">Year</th>
                        <th class="p-4 font-bold">Reference</th>
                    </tr>
                </thead>
                <tbody id="publication-table-body" class="divide-y">
                </tbody>
            </table>
        </div>
    </div>
</section>

<section id="inversion" class="page container mx-auto px-4 py-12">
    <div class="bg-white p-6 rounded-xl shadow mb-10">
        
        <div class="flex justify-between mb-4 border-b pb-3">
            <div>
                <h2 class="text-2xl font-bold text-green-900">Inversion Emission</h2>
                <p class="text-sm text-gray-500">Top-down estimations with uncertainty ranges (Mean ± SD)</p>
            </div>
            <button onclick="handleDownload('inversion.csv')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                Download Data
            </button>
        </div>

        <div class="grid md:grid-cols-5 gap-4 mb-6">
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Substance</label>
                <select id="inv-substance" onchange="handleInvSubstanceChange()" class="w-full border p-2 rounded text-sm">
                   <option>CFC-11</option><option>CFC-12</option>
                    <option>HCFC-22</option><option>HCFC-141b</option><option>HCFC-142b</option><option>HCFC-124</option>
                    <option>HFC-134a</option><option>HFC-143a</option><option>HFC-32</option>
                    <option>HFC-125</option><option>HFC-152a</option><option>HFC-23</option><option>HFC-227ea</option><option>HFC-236fa</option><option>HFC-245fa</option><option>HFC-365mfc</option><option>SF6</option><option>CCl4</option><option>CH3Br</option><option>CH3CCl3</option>
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Region</label>
                <select id="inv-country" onchange="handleInvFilterChange()" class="w-full border p-2 rounded text-sm">
                    <option>China</option><option>Northern China</option><option>Eastern China</option>
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Start Year</label>
                <select id="inv-start-year" class="w-full border p-2 rounded text-sm">
                    </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">End Year</label>
                <select id="inv-end-year" class="w-full border p-2 rounded text-sm"></select>
            </div>

            <div class="flex items-end">
                <button onclick="renderInversionChart()" class="w-full bg-green-700 text-white font-bold py-2 rounded hover:bg-green-800 transition uppercase text-xs h-[38px]">
                    Update Chart
                </button>
            </div>
        </div>

        <div id="inversion-chart" class="w-full h-[520px]"></div>
    </div>

    <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 mb-8">
        <h3 class="text-2xl font-bold text-gray-900 mb-4 border-l-4 border-green-600 pl-4">Methodology</h3>
        <p class="text-gray-600 leading-relaxed italic">
            The top-down approach utilizes atmospheric concentration observations, integrated with atmospheric transport models and inversion algorithms, to estimate total emissions and their spatial distributions. This methodology is generally classified into the interspecies ratio method (ISC) and the inversion method. For detailed methodologies, please refer to the publications listed below.
        </p>
    </div>

<div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
        <h3 class="text-xl font-bold text-gray-900 mb-6">Publications</h3>
    <div class="overflow-x-auto">
        <table class="w-full text-left text-sm border-collapse">
            <thead>
                <tr class="bg-gray-50 border-b">
                        <th class="p-4 font-bold">Study</th>
                        <th class="p-4 font-bold">Substance</th>
                        <th class="p-4 font-bold">Region</th>
                        <th class="p-4 font-bold">Year</th>
                        <th class="p-4 font-bold">Reference</th>
                </tr>
            </thead>
            <tbody id="inversion-ref-table" class="divide-y">
                </tbody>
        </table>
    </div>
</div>

</section>

        <section id="comparison" class="page container mx-auto px-4 py-12">
            <div class="bg-white p-6 rounded-xl shadow mb-10">
                <div class="flex justify-between mb-4 border-b pb-3">
                    <div>
                        <h2 class="text-2xl font-bold text-indigo-900">OFED & Other Datasets</h2>
                        <p class="text-sm text-gray-500">Comparison of Bottom-up inventories and Top-down (Inverse Modeling & ISC) estimates.</p>
                    </div>
                    <button onclick="handleDownload('comparison.csv')" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition">
                        Download Data
                    </button>
                </div>
<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6 items-end">

    <div>
        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Substance</label>
        <select id="comp-substance" onchange="handleCompSubstanceChange()" class="w-full border p-2 rounded text-sm h-[38px] bg-white">
            <option>CFC-11</option><option>CFC-12</option><option>CFC-113</option><option>CFC-13</option><option>CFC-114</option><option>CFC-115</option><option>HCFC-22</option><option>HCFC-141b</option><option>HCFC-142b</option><option>HCFC-124</option><option>HCFC-133a</option><option>HCFC-132b</option><option>HFC-134a</option>
            <option>HFC-143a</option><option>HFC-32</option><option>HFC-125</option><option>HFC-152a</option><option>HFC-23</option><option>HFC-227ea</option><option>HFC-236fa</option><option>HFC-245fa</option><option>HFC-365mfc</option><option>HFC-4310mee</option><option>SF6</option><option>NF3</option><option>CF4</option><option>C2F6</option><option>C3F8</option><option>c-C4F8</option>
            <option>HFO-1234yf</option><option>HFO-1234ze</option><option>HCFO-1233zd</option><option>CH3Cl</option><option>CH2Cl2</option><option>CHCl3</option><option>CCl4</option><option>PCE</option><option>TCE</option><option>CH3Br</option><option>SO2F2</option><option>CH3CCl3</option><option>H-1211</option><option>H-1301</option><option>H-2402</option>
        </select>
    </div>

    <div>
    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Region</label>
    <select id="comp-region" onchange="updateComparisonYearRange(); " class="w-full border p-2 rounded text-sm h-[38px] bg-white">
        <option value="" disabled selected>Please select Substance first</option>
    </select>
    </div>

    <div>
        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Start Year</label>
        <select id="comp-start-year" class="w-full border p-2 rounded text-sm h-[38px] bg-white"></select>
    </div>

    <div>
        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">End Year</label>
        <select id="comp-end-year" class="w-full border p-2 rounded text-sm h-[38px] bg-white"></select>
    </div>

    <div>
        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Method Category</label>
        <select id="comp-method-filter" onchange="updateComparisonYearRange(); " class="w-full border p-2 rounded text-sm h-[38px] bg-white">
            <option value="All">All Methods</option>
            <option value="Bottom-up">Bottom-up</option>
            <option value="Top-down">Top-down (Inverse Modeling/ISC)</option>
        </select>
    </div>

    <div>
        <button onclick="renderComparisonChart()" class="w-full bg-indigo-700 text-white font-bold py-2 rounded hover:bg-indigo-800 transition uppercase text-xs h-[38px] flex items-center justify-center">
            Update Comparison
        </button>
    </div>
</div>
                <div id="comparison-chart" class="w-full h-[600px]"></div>
            </div>
            <div class="bg-white p-8 rounded-xl shadow border border-gray-100">
                <h3 class="text-xl font-bold text-gray-900 mb-6 border-l-4 border-indigo-600 pl-4">Publications</h3>
<div class="overflow-x-auto">
        <table class="w-full text-left text-sm border-collapse">
            <thead>
                <tr class="bg-gray-50 border-b">
                        <th class="p-4 font-bold">Study</th>
                        <th class="p-4 font-bold">Substance</th>
                        <th class="p-4 font-bold">Region</th>
                        <th class="p-4 font-bold">Year</th>
                        <th class="p-4 font-bold">Method</th>
                        <th class="p-4 font-bold">Reference</th>
                </tr>
            </thead>
<tbody id="comp-table-body" class="divide-y divide-gray-200">
            </tbody>
    </table>
</div>
            </div>
        </section>

<section id="about" class="page">
    <div class="bg-blue-50 py-6 border-b border-blue-100 text-center px-4 mb-8">
        <h1 class="text-3xl md:text-4xl font-extrabold text-blue-900 mb-4">Meet the Team</h1>
        <p class="text-lg text-gray-600 max-w-3xl mx-auto">
            Our team is dedicated to the research of ODSs and F-gases emissions.
        </p>
    </div>

    <div class="container mx-auto px-4 pb-12 max-w-6xl">
        
        <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4 border-l-4 border-blue-600 pl-4">Team Introduction</h2>
            <div class="text-gray-600 space-y-4 leading-relaxed text-justify">
    <p>
        <span class="font-semibold text-blue-900">Led by Zhejiang University</span> in collaboration with Peking University and Beijing Jiaotong University, our interdisciplinary team serves as co-authors of the <span class="italic">WMO Scientific Assessment of Ozone Depletion</span>. We are dedicated to resolving the challenges of emissions sourcing for ODSs and F-gases.
    </p>
    <p>
        By integrating <span class="font-medium">emission inventories, atmospheric observations, and inversion modeling</span>, we have established a dual-accounting system that bridges "bottom-up" and "top-down" approaches. Our research focuses on the environmental impacts of halogenated substances on ozone depletion and climate change, alongside the development of environmental policies. Through high-precision data, we provide vital scientific support for ozone layer protection, carbon neutrality, and global climate mitigation, contributing to both national and international compliance.
    </p>
</div>
        </div>

<div class="mb-4">
    <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">Core Members</h2>
    <div class="grid md:grid-cols-3 gap-6">
        
        <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 text-center hover:shadow-md transition duration-300">
            <div class="w-32 h-32 mx-auto mb-6 relative">
                <img src="fang.jpg" alt="Xuekun Fang" 
                     class="w-full h-full rounded-full object-cover border-4 border-blue-50 shadow-sm">
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-1">Xuekun Fang</h3>
            <p class="text-blue-600 font-medium mb-2">Zhejiang University</p>
            <div class="text-sm text-gray-500 space-y-1">
                <p class="text-blue-500 break-all font-mono">fangxuekun@zju.edu.cn</p>
            </div>
        </div>

        <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 text-center hover:shadow-md transition duration-300">
            <div class="w-32 h-32 mx-auto mb-6 relative">
                <img src="hu.jpg" alt="Jianxin Hu" 
                     class="w-full h-full rounded-full object-cover border-4 border-green-50 shadow-sm">
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-1">Jianxin Hu</h3>
            <p class="text-green-600 font-medium mb-2">Peking University</p>
            <div class="text-sm text-gray-500 space-y-1">
                <p class="text-blue-500 break-all font-mono">jianxin@pku.edu.cn</p>
            </div>
        </div>

        <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 text-center hover:shadow-md transition duration-300">
            <div class="w-32 h-32 mx-auto mb-6 relative">
                <img src="wu.jpg" alt="Jing Wu" 
                     class="w-full h-full rounded-full object-cover border-4 border-indigo-50 shadow-sm">
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-1">Jing Wu</h3>
            <p class="text-indigo-600 font-medium mb-2">Beijing Jiaotong University</p>
            <div class="text-sm text-gray-500 space-y-1">
                <p class="text-blue-500 break-all font-mono">wujing.108@bjtu.edu.cn</p>
            </div>
        </div>

    </div>
</div>
    </div>
</section>

        <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="bg-white w-full max-w-md rounded-xl p-6">
                <h2 class="text-xl font-bold mb-4" id="auth-title">Login</h2>
                <div id="register-fields" class="space-y-2 hidden">
                    <input id="reg-name" class="w-full border p-2 rounded" placeholder="Full Name">
                    <input id="reg-country" class="w-full border p-2 rounded" placeholder="Country">
                    <input id="reg-org" class="w-full border p-2 rounded" placeholder="Organization">
                    <input id="reg-dep" class="w-full border p-2 rounded" placeholder="Department">
                </div>
                <input id="auth-email" class="w-full border p-2 rounded mt-2" placeholder="Email">
                <div class="flex justify-between mt-4">
                    <button onclick="submitAuth()" class="bg-blue-600 text-white px-4 py-2 rounded">Submit</button>
                    <button id="toggle-btn" onclick="toggleAuthMode()" class="text-blue-600 text-sm">Switch to Register</button>
                </div>
                <button onclick="closeAuthModal()" class="text-gray-400 text-xs mt-3">Cancel</button>
            </div>
        </div>

    </main>

<footer class="bg-gray-900 text-gray-400 py-6 border-t border-gray-800">
        <div class="container mx-auto px-4 text-center">
            <p class="text-white mb-2">Ozone-depleting Substances & Fluorinated gases Emissions Database (OFED)</p>
            <p class="text-sm">If there are any omissions or errors, please inform us by email: <a href="mailto:contact@ofed.com" class="text-blue-400 underline">contact@ofed.com</a></p>
            <p class="mt-4 text-xs text-gray-600 tracking-widest uppercase italic">www.ofed.com</p>
        </div>
    </footer>

    <script>
    let inventoryData = [];
    let inversionData = [];
    let comparisonData = [];
    let isLoggedIn = false;
    let currentInvChartType = 'line';
    let authMode = 'login';

    const myExtendedColors = ['#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de', '#3ba272', '#fc8452', '#9a60b4', '#ea7ccc', '#2f4554', '#61a0a8', '#d48265'];
    const currentYear = new Date().getFullYear();
    const yearsRange = Array.from({length: currentYear - 1980 + 2}, (_, i) => 1980 + i);

// 通用函数：根据提供的数据数组更新年份下拉框
function updateYearSelects(data, startSelectId, endSelectId) {
    const startSelect = document.getElementById(startSelectId);
    const endSelect = document.getElementById(endSelectId);
    if (!data || data.length === 0 || !startSelect || !endSelect) return;

    // 1. 提取数据中的所有年份
    const years = data.map(d => parseInt(d.year)).filter(y => !isNaN(y));
    if (years.length === 0) return;

    const minYear = Math.min(...years);
    const maxYear = Math.max(...years);

    // 2. 设定显示范围：起始为 min-1, 终止为 max+1 [cite: 307]
    const displayStart = minYear - 1;
    const displayEnd = maxYear + 1;

    // 3. 清空并填充下拉框
    startSelect.innerHTML = '';
    endSelect.innerHTML = '';
    for (let y = displayStart; y <= displayEnd; y++) {
        startSelect.add(new Option(y, y));
        endSelect.add(new Option(y, y));
    }

    // 4. 设置初始状态：起始年份选最小值，终止年份选最大值 [cite: 307]
    startSelect.value = displayStart;
    endSelect.value = displayEnd;
}

    // 1. Data Loading
    async function loadData() {
        try {
            console.log("Starting to load CSV data...");
            const fetchCSV = async (url) => {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for ${url}`);
                const csvText = await response.text();
                return new Promise(resolve => {
                    Papa.parse(csvText, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        complete: (results) => resolve(results.data)
                    });
                });
            };

            // Ensure these filenames match exactly what you upload to GitHub
            const [inv, invs, comp] = await Promise.all([
                fetchCSV('inventory.csv'),
                fetchCSV('inversion.csv'),
                fetchCSV('comparison.csv')
            ]);

            inventoryData = inv;
            inversionData = invs;
            comparisonData = comp;
            console.log("Data loaded successfully");
            return true;

        } catch (error) {
            console.error("Failed to load data:", error);
            document.body.insertAdjacentHTML('afterbegin', `<div class="bg-red-500 text-white p-4 text-center sticky top-0 z-[60]">Data loading failed: ${error.message}. Please check that inventory.csv, inversion.csv, and comparison.csv exist in the repository.</div>`);
            return false;
        }
    }

   // 2. Initialization
window.addEventListener("load", async () => {
    // 初始化年份基础下拉框
    initSelects();
    initInversionSelect();
    initComparisonSelect();
    
    // 加载 CSV 数据
    const success = await loadData();
    
    if (success) {
        // --- 1. 清单页面 (Inventory) 默认设置 ---
        const subSel = document.getElementById('substance-select');
        const regSel = document.getElementById('region-select');
        // 索引 1 通常是第一个物质（索引 0 是 placeholder）
        if (subSel.options.length > 0) subSel.selectedIndex = 0; 
        if (regSel.options.length > 0) regSel.selectedIndex = 0; 
        
        handleMainFilterChange(); // 触发更新年份范围和来源下拉框 [cite: 71]
        setActiveButton('btn-line'); // 设置“Total (Line)”按钮为激活状态 
        updateInventoryChart("line"); // 执行画图 [cite: 82]

        // --- 2. 反演页面 (Inversion) 默认设置 ---
       const invSub = document.getElementById('inv-substance');
       const invReg = document.getElementById('inv-country');

// 步骤 1: 确保物质下拉框有数据并选中第一个有效物质（通常索引 1 是第一个物质）
if (invSub.options.length > 0) {
    invSub.selectedIndex = 0; 
    
    // 步骤 2: 必须先触发物质变化联动，以填充对应的“地区”选项
    // 确保您有一个 handleInvSubstanceChange 函数来根据物质更新地区下拉框
    handleInvSubstanceChange(); 

    // 步骤 3: 地区联动后，自动选中出现的第一个地区
    if (invReg.options.length > 0) {
        invReg.selectedIndex = 0; // 选中新填充列表的第一个地区
    }

    // 步骤 4: 触发年份范围更新
    handleInvFilterChange(); 

    // 步骤 5: 最后执行画图
    renderInversionChart(); 
}

        // --- 3. 对比页面 (Comparison) 默认初始化设置 ---
const compSub = document.getElementById('comp-substance');
const compReg = document.getElementById('comp-region');

if (compSub && compSub.options.length > 0) {
    // 步骤 1: 选中第一个物质
    compSub.selectedIndex = 0; 
    
    // 步骤 2: 触发物质联动（填充地区列表、选中首个地区、更新年份范围）
    handleCompSubstanceChange(); 

    // 步骤 3: 确保地区已被填充并选中第一个（在 handleCompSubstanceChange 已处理，这里做双重保险）
    if (compReg.options.length > 0) {
        compReg.selectedIndex = 0;
    }

    // 步骤 4: 再次确认年份范围已更新
    updateComparisonYearRange();

    // 步骤 5: 初始自动执行画图
    renderComparisonChart();
}
    }
    
    // 默认显示首页
    showPage("home");
});

    window.onresize = function() {
        ['inventory-chart', 'inversion-chart', 'comparison-chart'].forEach(id => {
            const chart = echarts.getInstanceByDom(document.getElementById(id));
            if(chart) chart.resize();
        });
    };

    // 3. Navigation
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');

        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        if(pageId === 'home') document.getElementById('nav-home')?.classList.add('active');
        if(pageId === 'inventory') document.getElementById('nav-inventory')?.classList.add('active');
        if(pageId === 'inversion') document.getElementById('nav-inversion')?.classList.add('active');
        if(pageId === 'comparison') document.getElementById('nav-comparison')?.classList.add('active');
        if(pageId === 'about') document.getElementById('nav-about')?.classList.add('active');

        window.scrollTo(0, 0);

        // Re-render charts when tab switches to ensure correct width
        setTimeout(() => {
            if(pageId === 'inventory') updateInventoryChart(currentInvChartType);
            if(pageId === 'inversion') renderInversionChart();
            if(pageId === 'comparison') renderComparisonChart();
        }, 100);
    }

    // 4. Dropdown Initialization Helpers
    function initSelects() {
        const s = document.getElementById('start-year');
        const e = document.getElementById('end-year');
        fillYears(s, e);
    }
    function initInversionSelect() {
        const s = document.getElementById('inv-start-year');
        const e = document.getElementById('inv-end-year');
        fillYears(s, e);
    }
    function initComparisonSelect() {
        const s = document.getElementById('comp-start-year');
        const e = document.getElementById('comp-end-year');
        fillYears(s, e);
    }
    function fillYears(s, e) {
        if(!s || !e) return;
        s.innerHTML = ''; e.innerHTML = '';
        yearsRange.forEach(y => {
            s.add(new Option(y, y));
            e.add(new Option(y, y));
        });
    }

    // 5. Chart Logic - Inventory
// 1. 窗口大小自适应
window.addEventListener('resize', function() {
    const chartDom = document.getElementById('inventory-chart');
    const chart = echarts.getInstanceByDom(chartDom);
    if (chart) chart.resize();
});

function setActiveButton(activeId) {
    // 1. 找到所有的图表按钮
    const buttons = document.querySelectorAll('.chart-btn');
    
    buttons.forEach(btn => {
        if (btn.id === activeId) {
            // 2. 激活态：深蓝色背景，白色文字
            btn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
            btn.classList.add('bg-blue-900', 'text-white', 'hover:bg-black');
        } else {
            // 3. 非激活态：灰色背景，深灰色文字
            btn.classList.remove('bg-blue-900', 'text-white', 'hover:bg-black');
            btn.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
        }
    });
}


// 2. 主过滤器逻辑
function handleMainFilterChange() {
    const substance = document.getElementById('substance-select').value;
    const region = document.getElementById('region-select').value;

    if (!substance || !region) return;

    // 1. 仅更新年份和下拉框，不画图
    const filtered = inventoryData.filter(d => d.substance === substance && d.region === region);
    if (typeof updateYearSelects === 'function') {
        updateYearSelects(filtered, 'start-year', 'end-year');
    }

    syncReferenceDropdown(substance, region);
    updatePublicationTable(substance, region);
}

// 3. 同步研究来源下拉框
function syncReferenceDropdown(substance, region) {
    const refSelect = document.getElementById('reference-select');
    
// 先过滤出当前物质和地区的所有基础数据
    const filteredData = inventoryData.filter(d => 
        d.substance === substance && d.region === region
    );

    // 找出那些拥有“非 total”行业数据的研究来源名称
    const sourcesWithSectors = [...new Set(filteredData
        .filter(d => d.sector.toLowerCase() !== "total") // 核心修改：只保留行业数据行
        .map(d => d.ref_short)
    )];

    // 填充下拉框
    if (sourcesWithSectors.length > 0) {
        refSelect.innerHTML = sourcesWithSectors.map(s => 
            `<option value="${s}">${s}</option>`
        ).join('');
    } else {
        // 如果该物质下没有任何分行业数据，显示提示
        refSelect.innerHTML = '<option value="">Only Total Available</option>';
    }
}

// 4. 更新表格逻辑
function updatePublicationTable(substance, region) {
    const tableBody = document.getElementById('publication-table-body');
    const filteredData = inventoryData.filter(d => d.substance === substance && d.region === region);
    const uniqueShorts = [...new Set(filteredData.map(d => d.ref_short))];

    if (uniqueShorts.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-400">No references available.</td></tr>`;
        return;
    }

    tableBody.innerHTML = uniqueShorts.map(short => {
        const studyData = filteredData.filter(d => d.ref_short === short);
        const years = studyData.map(d => d.year);
        const yearRange = `${Math.min(...years)}–${Math.max(...years)}`;
        const fullRef = studyData[0].ref_full || 'N/A';

        return `
            <tr class="hover:bg-gray-50 transition">
                <td class="p-4 font-bold text-blue-900">${short}</td>
                <td class="p-4">${substance}</td>
                <td class="p-4">${region}</td>
                <td class="p-4 text-gray-500">${yearRange}</td>
                <td class="p-4 italic text-gray-600">${fullRef}</td>
            </tr>
        `;
    }).join('');
}

// 5. 核心图表逻辑
function updateInventoryChart(type) {
    const substance = document.getElementById('substance-select').value;
    const region = document.getElementById('region-select').value;
    const sYear = parseInt(document.getElementById('start-year').value);
    const eYear = parseInt(document.getElementById('end-year').value);
    const selectedRefShort = document.getElementById('reference-select').value;

    const chartDom = document.getElementById('inventory-chart');
    let chart = echarts.getInstanceByDom(chartDom) || echarts.init(chartDom);
    chart.resize(); // 强制调整大小
    chart.clear();

    const yearRange = Array.from({length: eYear - sYear + 1}, (_, i) => sYear + i);
    let baseFiltered = inventoryData.filter(d => 
        d.substance === substance && d.region === region && d.year >= sYear && d.year <= eYear
    );

   let option = {
        color: myExtendedColors,
        title: { left: "center", top: 0, textStyle: { fontSize: 16 } },
        // ================== 核心修改部分：自定义 Tooltip ==================
        tooltip: { 
            trigger: "axis", 
            confine: true,
            formatter: function (params) {
                // params 是当前横坐标下所有系列的数据点数组
                let res = `<b>Year: ${params[0].name}</b><br/>`;
                let hasData = false;

                params.forEach(item => {
                    // 只有当数据值不是 null、undefined 且不是 '-' 时才显示
                    if (item.value !== null && item.value !== undefined && item.value !== '-') {
                        res += `${item.marker} ${item.seriesName}: <b>${item.value}</b><br/>`;
                        hasData = true;
                    }
                });

                // 如果这一年所有研究都没有数据，返回空或提示
                return hasData ? res : `<b>Year: ${params[0].name}</b><br/>`;
            }
        },
        // ================================================================
        legend: { bottom: 0, padding: [5, 10] },
        xAxis: { 
    type: "category", 
    data: yearRange,
    // 1. 让刻度线和标签位于像素中心点（默认是 false，标签在两个刻度中间）
    boundaryGap: type === "line" ? false : true, 
    axisTick: {
        alignWithLabel: true // 2. 确保刻度线与标签对齐
    },
    axisLabel: {
        interval: 'auto', // 自动计算密度，防止重叠
        hideOverlap: true  // 如果年份太密，自动隐藏重叠的标签
    }
},
        yAxis: { type: "value", name: "Gg yr⁻¹" },
        grid: { top: '60px', bottom: '60px', left: '50px', right: '20px', containLabel: true }
    };

    if (type === "line") {
        const sources = [...new Set(baseFiltered.map(d => d.ref_short))];
        option.title.text = `${substance} Emission Trends: ${region}`;
        option.series = sources.map(short => ({
            name: short,
            type: 'line',
            smooth: true,
            symbol: 'circle',
            symbolSize: 6,
            connectNulls: false, // 确保无数据时不连线
            data: yearRange.map(y => {
                const row = baseFiltered.find(d => d.year === y && d.ref_short === short && d.sector.toLowerCase() === "total");
                // 确保没有数据时返回 null 而不是 0，这样 formatter 才能过滤掉
                return row ? row.value : null; 
            })
        }));
    } else {
        // ... (Bar Chart 部分保持不变，因为它已经有了 selectedRefShort 过滤，通常不会有空行)
        // 但为了统一，Bar Chart 也会应用上面定义的自定义 tooltip
        if (!selectedRefShort) {
            chart.setOption({ title: { text: "Please select a substance with valid sources", left: "center" } });
            return;
        }
        const refData = baseFiltered.filter(d => d.ref_short === selectedRefShort && d.sector.toLowerCase() !== "total");
        const sectors = [...new Set(refData.map(d => d.sector))];
        option.title.text = `${substance} Sectors (${selectedRefShort}) - ${region}`;
        option.series = sectors.map(sec => ({
            name: sec,
            type: "bar",
            stack: "total",
            data: yearRange.map(y => {
                const row = refData.find(d => d.year === y && d.sector === sec);
                return row ? row.value : null;
            })
        }));
    }
    chart.setOption(option);
}

// ==========================================
// 修复部分：页面初始化逻辑 (Fix)
// ==========================================
document.addEventListener('DOMContentLoaded', function() {
    // 1. 初始化年份下拉框 (保持不变)
    const startYearSelect = document.getElementById('start-year');
    const endYearSelect = document.getElementById('end-year');
    
    let yearOptions = '';
    for(let y = 1980; y <= 2024; y++) {
        yearOptions += `<option value="${y}">${y}</option>`;
    }
    startYearSelect.innerHTML = yearOptions;
    endYearSelect.innerHTML = yearOptions;
    
    startYearSelect.value = "1980";
    endYearSelect.value = "2024";

    // 2. 将物质和地区重置为初始状态 (即选中那个 "请选择" 选项)
    document.getElementById('substance-select').selectedIndex = 0;
    document.getElementById('region-select').selectedIndex = 0;
    
    // 3. 初始化下拉框和表格（此时由于没选物质，会显示 "No Sources"）
    handleMainFilterChange();

    // 4. 注意：这里不再调用 updateInventoryChart('line')
    // 只有当用户选择了具体数值后，通过 handleMainFilterChange 触发更新
});

    // 6. Chart Logic - Inversion
// 处理物质变化：仅联动更新地区和年份，不画图
function handleInvSubstanceChange() {
    const subVal = document.getElementById('inv-substance').value;
    const regSel = document.getElementById('inv-country');
    
    if (!subVal || !inversionData.length) return;

    // 1. 动态筛选该物质对应的区域
    const availableRegions = [...new Set(
        inversionData
            .filter(d => (d.substance === subVal || d.Substance === subVal))
            .map(d => d.region || d.Region || d.country)
    )].filter(r => r).sort();

    // 2. 更新地区下拉框
    regSel.innerHTML = ''; 
    availableRegions.forEach(reg => {
        regSel.add(new Option(reg, reg));
    });
    regSel.selectedIndex = 0;

    // 3. 联动更新年份范围（基于新选中的第一个地区）
    handleInvFilterChange();
}

// 处理地区/其他过滤变化：仅更新年份，不画图
function handleInvFilterChange() {
    const sub = document.getElementById('inv-substance').value;
    const reg = document.getElementById('inv-country').value;
    
    if (sub && reg) {
        const filtered = inversionData.filter(d => 
            (d.substance === sub || d.Substance === sub) && 
            (d.region === reg || d.Region === reg || d.country === reg)
        );
        // 自动更新年份选择器，方便用户查看可选范围
        updateYearSelects(filtered, 'inv-start-year', 'inv-end-year');
    }
}

function renderInversionChart() {
    const chartDom = document.getElementById("inversion-chart");
    if (!chartDom) return;

    // 1. 获取当前筛选值
    const substance = document.getElementById("inv-substance").value;
    const region = document.getElementById("inv-country").value;
    const sYear = parseInt(document.getElementById("inv-start-year").value);
    const eYear = parseInt(document.getElementById("inv-end-year").value);

    // 校验年份逻辑
    if (sYear > eYear) {
        alert("Start year cannot be greater than end year");
        return;
    }

    // 初始化/获取图表实例
    let chart = echarts.getInstanceByDom(chartDom);
    if (chart) {
        chart.dispose();
    }
    chart = echarts.init(chartDom);

    // 2. 构造完整的横坐标年份数组
    // 确保这是一个连续的整数数组，使数据点落在刻度线上
    const yearRange = [];
    for (let y = sYear; y <= eYear; y++) {
        yearRange.push(y);
    }

    // 3. 过滤数据
    const filtered = inversionData.filter(d =>
        d.substance === substance &&
        d.region === region &&
        d.year >= sYear &&
        d.year <= eYear
    );

// ============= 新增：更新参考文献表格 =============
    updateReferenceTable(filtered);

    // 4. 检查是否有数据（无数据时显示提示）
    if (filtered.length === 0) {
        chart.setOption({
            title: { text: `${substance} Inversion Emissions (${region})`, left: "center" },
            graphic: {
                type: 'text',
                left: 'center',
                top: 'middle',
                style: { text: 'No Data Available', fill: '#999', font: 'bold 18px sans-serif' }
            },
            xAxis: { show: false },
            yAxis: { show: false },
            series: []
        });
        return;
    }

    const studies = [...new Set(filtered.map(d => d.study))];
    let series = [];
    let allValues = [0]; 

    // 5. 构造 Series
    studies.forEach(study => {
        const rows = filtered.filter(d => d.study === study);
        const lineData = [];
        const errorData = [];

        // 遍历 yearRange 确保每个年份索引对应正确
        yearRange.forEach((y, idx) => {
            const r = rows.find(d => d.year === y);
            
            // 如果该年份没有该研究的数据，存入 null 以保持坐标对齐且不连线
            if (!r) {
                lineData.push(null); 
                return;
            }

            const val = r.mean ?? r.Mean;
            const sd  = r.sd ?? r.SD ?? 0;

            if (val !== undefined && val !== null) {
                // 存入对象以便 formatter 调用
                lineData.push({
                    value: val,
                    sdValue: sd 
                });
                allValues.push(val);

                if (sd > 0) {
                    const low = val - sd;
                    const high = val + sd;
                    // 存储索引 idx 以确保误差棒精准对齐刻度
                    errorData.push([idx, low, high]);
                    allValues.push(high);
                }
            } else {
                lineData.push(null);
            }
        });

        // 折线系列配置
        series.push({
            name: study,
            type: "line",
            data: lineData,
            smooth: false,      // 需求1：直线连接
            symbol: "circle",
            symbolSize: 8,
            z: 20,
            connectNulls: false // 需求2：无数据不显示且断开连接
        });

        // 误差棒系列配置
        if (errorData.length > 0) {
            series.push({
                type: "custom",
                name: study,
                renderItem: function (params, api) {
                    const xIndex = api.value(0);
                    const low = api.coord([xIndex, api.value(1)]);
                    const high = api.coord([xIndex, api.value(2)]);
                    const half = 5; // 误差棒横线宽度
                    const style = api.style({
                        stroke: api.visual('color'),
                        lineWidth: 1.5
                    });
                    return {
                        type: 'group',
                        children: [
                            { type: 'line', shape: { x1: high[0], y1: high[1], x2: low[0], y2: low[1] }, style },
                            { type: 'line', shape: { x1: high[0]-half, y1: high[1], x2: high[0]+half, y2: high[1] }, style },
                            { type: 'line', shape: { x1: low[0]-half, y1: low[1], x2: low[0]+half, y2: low[1] }, style }
                        ]
                    };
                },
                data: errorData,
                z: 10,
                tooltip: { show: false }
            });
        }
    });

    // 计算 Y 轴动态范围
    //const rawMax = Math.max(...allValues);
    //const interval = Math.ceil((rawMax || 10) / 5 / 2) * 2; 
    //const yMax = interval * 5;
// 1. 拿到包含标准差的最大值
const rawMax = Math.max(...allValues);

// 2. 计算理想的最大值和等分间距
let smartMax, smartInterval;

if (rawMax <= 0 || !isFinite(rawMax)) {
    smartMax = 1;
    smartInterval = 0.2;
} else {
    // 稍微给 15% 的余量
    const targetMax = rawMax * 1.15;
    
    // 寻找一个整齐的步长 (Step)
    // 根据数量级找到合适的刻度值 (如 0.1, 0.2, 0.5, 1, 2, 5, 10...)
    const magnitude = Math.pow(10, Math.floor(Math.log10(targetMax)));
    const candidateSteps = [0.1, 0.2, 0.25, 0.3, 0.5, 1, 2, 2.5, 3, 5, 10].map(s => s * magnitude / 1);
    
    // 找到第一个能覆盖 targetMax / 5 的整齐刻度
    const idealStep = candidateSteps.find(s => s >= targetMax / 5) || candidateSteps[candidateSteps.length - 1];
    
    smartInterval = idealStep;
    smartMax = idealStep * 5; // 强制 5 等分
}

    // 6. 设置图表最终 Option
    chart.setOption({
        color: myExtendedColors,
         title: { 
            text: `${substance} Inversion Emissions (${region})`, 
            left: "center",
            top: 10 
        },
        tooltip: { 
            trigger: "axis",
            backgroundColor: 'rgba(255, 255, 255, 0.9)',
            formatter: function(params) {
                let res = `<b>Year: ${params[0].name}</b><br/>`;
                let hasValidData = false;
                params.forEach(p => {
                    if (p.seriesType === 'line' && p.value !== null && p.value !== undefined) {
                        const val = typeof p.value === 'object' ? p.value.value : p.value;
                        const sd = p.data.sdValue !== undefined ? p.data.sdValue : 0;
                        res += `${p.marker} ${p.seriesName}: <b>${val}</b> (±${sd})<br/>`;
                        hasValidData = true;
                    }
                });
                return hasValidData ? res : null; // 如果整行无数据则不显示 Tooltip
            }
        },
        legend: { bottom: 5, data: studies },
        grid: { left: '5%', right: '5%', bottom: '15%', containLabel: true },
        xAxis: {
            type: "category",
            data: yearRange,
            // 关键修改：boundaryGap 设为 true 让点落在刻度中间，
            // 配合 axisTick 的 alignWithLabel 确保刻度线对准年份。
            boundaryGap: true, 
            axisTick: {
                alignWithLabel: true 
            },
            axisLabel: {
                interval: 0,
                rotate: yearRange.length > 12 ? 45 : 0 // 年份过多自动旋转
            }
        },
       yAxis: {
    type: "value",
    name: "Gg yr⁻¹",
    min: 0,
    max: smartMax, 
    interval: smartInterval, // 关键修改：强制每一个刻度的间距完全一致
    splitLine: { 
        lineStyle: { type: 'dashed' } 
    },
    axisTick: { show: true },
    axisLine: { show: true },
    axisLabel: {
    formatter: function(value) {
        // 如果数值本身就是整数，直接返回整数形式
        if (Number.isInteger(value)) {
            return value.toString();
        }
        // 否则根据间距动态决定小数位数
        return smartInterval < 0.1 ? value.toFixed(2) : value.toFixed(1);
    }
}
},
        series: series
    });
}

function updateReferenceTable(data) {
    const tableBody = document.getElementById("inversion-ref-table");
    const noDataMsg = document.getElementById("no-ref-msg");
    
    if (!tableBody) return;

    // 1. 清空现有内容
    tableBody.innerHTML = "";

    if (!data || data.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-400">No references available.</td></tr>`;
        return;
    }

    // 2. 按照 研究(study) + 物质(substance) + 区域(region) 进行分组
    const groups = {};

    data.forEach(item => {
        // 创建分组唯一键
        const groupKey = `${item.study}|${item.substance}|${item.region}`;
        
        if (!groups[groupKey]) {
            groups[groupKey] = {
                study: item.study,
                substance: item.substance,
                region: item.region,
                years: [],
                citation: item.citation || item.Citation || "Reference not provided in CSV"
            };
        }
        groups[groupKey].years.push(parseInt(item.year));
    });

    // 3. 将分组转换为数组并处理年份范围
    const summaryData = Object.values(groups).map(group => {
        const minYear = Math.min(...group.years);
        const maxYear = Math.max(...group.years);
        
        return {
            ...group,
            yearRange: minYear === maxYear ? `${minYear}` : `${minYear}–${maxYear}`
        };
    });

    // 4. 排序：按研究名称字母顺序排列
    summaryData.sort((a, b) => a.study.localeCompare(b.study));

    // 5. 渲染表格行
    summaryData.forEach(row => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-blue-50 transition-colors border-b border-gray-100";
        
        tr.innerHTML = `
            <td class="px-4 py-3 font-semibold text-blue-900">${row.study}</td>
            <td class="px-4 py-3 text-gray-700">${row.substance}</td>
            <td class="px-4 py-3 text-gray-700">${row.region}</td>
            <td class="px-4 py-3 text-gray-500 font-medium">${row.yearRange}</td>
            <td class="p4 italic text-gray-600">${row.citation}</td>
        `;
        tableBody.appendChild(tr);
    });
}

// 7. Chart Logic - Comparison (支持非对称误差棒)
function handleCompSubstanceChange() {
    const selectedSubstance = document.getElementById('comp-substance').value;
    const regionSelect = document.getElementById('comp-region');
    
    // 注意：这里纠正了你原代码中的变量名错误 (subVal 改为 selectedSubstance)
    if (!selectedSubstance || !comparisonData) return;

    // 1. 从 comparisonData 中过滤出该物质对应的所有唯一地区
    const availableRegions = [...new Set(comparisonData
        .filter(d => d.substance === selectedSubstance)
        .map(d => d.region)
    )].filter(r => r); // 过滤掉空值

    // 排序逻辑：Global优先，其他字母序
    availableRegions.sort((a, b) => {
        if (a === 'Global') return -1;
        if (b === 'Global') return 1;
        return a.localeCompare(b);
    });

    // 2. 更新地区下拉框的内容
    let optionsHtml = ''; // 移除 "-- Select Region --"
    
    if (availableRegions.length > 0) {
        availableRegions.forEach(reg => {
            optionsHtml += `<option value="${reg}">${reg}</option>`;
        });
    } else {
        optionsHtml = '<option value="">No regions available</option>';
    }
    
    regionSelect.innerHTML = optionsHtml;

    // 3. 【关键修改】默认选中第一个地区，并立即触发年份联动
    if (availableRegions.length > 0) {
        regionSelect.selectedIndex = 0; 
        // 只有在初始加载或需要联动更新年份时才调用
        updateComparisonYearRange();
    }
}

function updateComparisonYearRange() {
    const sub = document.getElementById("comp-substance").value;
    const reg = document.getElementById("comp-region").value;
    const methodFilter = document.getElementById("comp-method-filter").value;

    if (!sub) return; // 至少需要选择物质

    // 1. 过滤数据
    let filtered = comparisonData.filter(d => 
        (d.substance === sub || d.Substance === sub) &&
        (!reg || d.region === reg || d.Region === reg) // 如果还没选地区，则看该物质全量
    );

    // 2. 如果选了方法，进一步过滤
    if (methodFilter !== 'All') {
        filtered = filtered.filter(d => {
            const m = (d.method || d.Method || "").toLowerCase();
            if (methodFilter === 'Bottom-up') return m.includes('bottom-up');
            if (methodFilter === 'Top-down') return m.includes('inverse') || m.includes('isc');
            return true;
        });
    }

    // 3. 调用通用的 updateYearSelects 函数 (假设你已经按照之前的建议定义了它)
    // 如果没有统一定义，请使用下方的代码：
    const years = filtered.map(d => parseInt(d.year || d.Year)).filter(y => !isNaN(y));
    if (years.length > 0) {
        const minYear = Math.min(...years);
        const maxYear = Math.max(...years);
        
        const startSelect = document.getElementById('comp-start-year');
        const endSelect = document.getElementById('comp-end-year');
        
        // 清空并重新填充
        startSelect.innerHTML = '';
        endSelect.innerHTML = '';
        for (let y = (minYear - 1); y <= (maxYear + 1); y++) {
            startSelect.add(new Option(y, y));
            endSelect.add(new Option(y, y));
        }
        
        // 初始状态：1978 和 2024 (最小值-1 和 最大值+1)
        startSelect.value = minYear - 1;
        endSelect.value = maxYear + 1;
    }
}

function renderComparisonChart() {
    const chartDom = document.getElementById("comparison-chart");
    if (!chartDom) return;

    // 1. 获取筛选器值
    const substance = document.getElementById("comp-substance").value;
    const region = document.getElementById("comp-region").value;
    const sYear = parseInt(document.getElementById("comp-start-year").value);
    const eYear = parseInt(document.getElementById("comp-end-year").value);
    const methodFilter = document.getElementById("comp-method-filter").value;

    if (sYear > eYear) {
        alert("Start year cannot be greater than end year");
        return;
    }

    // 2. 构造年份范围
    const yearRange = [];
    for (let y = sYear; y <= eYear; y++) {
        yearRange.push(y);
    }

    // 3. 数据过滤（第一步：基础过滤）
    let filtered = comparisonData.filter(d =>
        (d.substance === substance || d.Substance === substance) &&
        (d.region === region || d.Region === region) &&
        (parseInt(d.year || d.Year) >= sYear) &&
        (parseInt(d.year || d.Year) <= eYear)
    );

    // 4. 数据过滤（第二步：方法分类过滤）
    if (methodFilter !== 'All') {
        filtered = filtered.filter(d => {
            const m = (d.method || d.Method || "").toLowerCase();
            if (methodFilter === 'Bottom-up') return m.includes('bottom-up');
            if (methodFilter === 'Top-down') return m.includes('inverse') || m.includes('isc');
            return true;
        });
    }

    // ============= 核心修正：调用统一的表格更新函数 =============
    // 不再在 renderComparisonChart 内部手动拼凑 tableHTML，避免覆盖冲突
    updateComparisonReferenceTable(filtered);
    // =========================================================

    // 5. 初始化图表
    let chart = echarts.getInstanceByDom(chartDom);
    if (chart) { chart.dispose(); }
    chart = echarts.init(chartDom);

    if (filtered.length === 0) {
        chart.setOption({
            title: { text: `${substance} Emissions (${region})`, left: "center" },
            graphic: {
                type: 'text', left: 'center', top: 'middle',
                style: { text: 'No Data Available', fill: '#999', font: 'bold 18px sans-serif' }
            }
        });
        return;
    }

// 6. 构造 Series（用于 ECharts）
    const datasets = [...new Set(filtered.map(d => d.dataset || d.study || d.Name))];
    let series = [];
    let allValuesForScale = [0];
    
    // --- 新增：初始化分类图例数组 ---
    const buLegends = [];
    const tdLegends = [];

    datasets.forEach(name => {
        const rows = filtered.filter(d => (d.dataset || d.study || d.Name) === name);
        const lineData = [];
        const errorData = [];
        const method = (rows[0]?.method || rows[0]?.Method || "Unknown").toLowerCase();

        // --- 新增：根据 method 归类图例 ---
        if (method.includes('bottom-up')) {
            buLegends.push(name);
        } else if (method.includes('inverse') || method.includes('isc')) {
            tdLegends.push(name);
        } else {
            // 如果都不匹配，可以默认放进一个组，或者加个 Other
            tdLegends.push(name); 
        }

        yearRange.forEach((y, idx) => {
            // ... (保持你原有的 lineData 和 errorData 处理逻辑不变) ...
            const r = rows.find(d => parseInt(d.year || d.Year) === y);
            if (!r) {
                lineData.push(null);
                return;
            }
            const val = r.value ?? r.mean ?? r.Mean;
            const errPos = parseFloat(r.err_pos || r.ErrPos || 0);
            const errNeg = parseFloat(r.err_neg || r.ErrNeg || 0);

            if (val !== undefined && val !== null) {
                lineData.push({ value: val, errPos: errPos, errNeg: errNeg });
                allValuesForScale.push(val);
                if (errPos > 0 || errNeg > 0) {
                    const upper = val + errPos;
                    const lower = val - errNeg;
                    errorData.push([idx, lower, upper]);
                    allValuesForScale.push(upper, lower);
                }
            } else {
                lineData.push(null);
            }
        });

        series.push({
            name: name,
            type: "line",
            data: lineData,
            connectNulls: false,
            symbol: method.includes("bottom-up") ? "circle" : "emptyTriangle",
            symbolSize: 8,
            z: 20
        });

        if (errorData.length > 0) {
            series.push({
                type: "custom",
                name: name,
                renderItem: function (params, api) {
                    // ... (保持你原有的 error bar 绘制逻辑不变) ...
                    const xIndex = api.value(0);
                    const low = api.coord([xIndex, api.value(1)]);
                    const high = api.coord([xIndex, api.value(2)]);
                    const half = 4;
                    const style = api.style({ stroke: api.visual('color'), lineWidth: 1.5, fill: null });
                    return {
                        type: 'group',
                        children: [
                            { type: 'line', shape: { x1: high[0], y1: high[1], x2: low[0], y2: low[1] }, style },
                            { type: 'line', shape: { x1: high[0] - half, y1: high[1], x2: high[0] + half, y2: high[1] }, style },
                            { type: 'line', shape: { x1: low[0] - half, y1: low[1], x2: low[0] + half, y2: low[1] }, style }
                        ]
                    };
                },
                data: errorData,
                z: 10,
                tooltip: { show: false }
            });
        }
    });

// 7. Y轴范围计算
const rawMax = Math.max(...allValuesForScale);
const rawMin = Math.min(...allValuesForScale); // 获取包含误差棒底端的绝对最小值

let smartMax, smartMin, smartInterval;

if (!isFinite(rawMax) || allValuesForScale.length <= 1) {
    smartMax = 1;
    smartMin = 0;
    smartInterval = 0.2;
} else {
    // --- 最小值逻辑 ---
    // 如果最小值小于 0，则设为最小值减去 10% 的余量；否则固定为 0
    smartMin = rawMin < 0 ? rawMin * 1.1 : 0;

    // --- 最大值逻辑 ---
    // 稍微给 15% 的余量
    const targetMax = rawMax * 1.15;
    const range = targetMax - smartMin;

    // 根据数据范围找到合适的刻度步长
    const magnitude = Math.pow(10, Math.floor(Math.log10(range)));
    const candidateSteps = [0.1, 0.2, 0.25, 0.3, 0.4, 0.5, 0.6, 0.8, 1, 1.2, 1.5, 1.6, 2, 3, 2.5, 5, 10].map(s => s * magnitude);
    
    // 找到能将范围大致分为 5 段的整齐刻度
    smartInterval = candidateSteps.find(s => s >= range / 5) || candidateSteps[candidateSteps.length - 1];
    
    // 重新对齐 smartMin 和 smartMax 到刻度上
    smartMin = Math.floor(smartMin / smartInterval) * smartInterval;
    smartMax = smartMin + smartInterval * 6; // 确保包含 targetMax
    
    // 再次检查：如果原本数据都大于0，且对齐后 smartMin 变成了负数（比如-0.1），强制回 0
    if (rawMin >= 0 && smartMin < 0) {
        smartMin = 0;
    }
}

    // 8. 设置图表配置
// --- 1. 动态布局参数准备 ---
const leftPos = '10%'; 
const titleArray = [{ text: `${substance} Emission Comparison (${region})`, left: "center", top: 10 }];
const legendArray = [];

// --- 2. 动态计算行数并优化布局 ---
const containerWidth = chartDom.clientWidth || 1000; // 获取容器宽度
const charWidth = 10; // 预估每个字符宽度
const itemPadding = 60; // 图例图标+间距的固定宽度
const itemsPerRow = Math.floor(containerWidth / 150); // 粗略预估一行放几个，150px为一个图例单元

// 计算 BU 占了几行
const buRows = Math.ceil(buLegends.length / itemsPerRow);
// 计算 TD 占了几行
const tdRows = Math.ceil(tdLegends.length / itemsPerRow);

// 动态高度单位 (每行大约占 4%-5%)
const rowHeight = 4.5; 
const titleGap = 6; // 标题与图例之间的间距

let gridBottomPercent = 25;

if (tdLegends.length > 0 && buLegends.length > 0) {
    // 1. Top-down 居于最底部
    const tdLegendBottom = 2; 
    const tdTitleBottom = tdLegendBottom + (tdRows * rowHeight);

    legendArray.push({
        data: tdLegends,
        bottom: tdLegendBottom + '%',
        left: leftPos,
        width: '85%',
        itemGap: 15
    });
    titleArray.push({
        text: 'Top-down:',
        left: leftPos,
        bottom: tdTitleBottom + '%',
        textStyle: { fontSize: 13, color: '#1e3a8a', fontWeight: 'bold' }
    });

    // 2. Bottom-up 根据 TD 的高度动态向上漂移
    // 这里的 4% 是 TD标题 与 BU图例 之间的额外空隙，你可以根据需要调小
    const buLegendBottom = tdTitleBottom + 4; 
    const buTitleBottom = buLegendBottom + (buRows * rowHeight);

    legendArray.push({
        data: buLegends,
        bottom: buLegendBottom + '%',
        left: leftPos,
        width: '85%',
        itemGap: 15
    });
    titleArray.push({
        text: 'Bottom-up:',
        left: leftPos,
        bottom: buTitleBottom + '%',
        textStyle: { fontSize: 13, color: '#1e3a8a', fontWeight: 'bold' }
    });

    // 3. 动态调整网格底部，确保不压到最上方的 BU 标题
    gridBottomPercent = buTitleBottom + 8;
} else {
    // 只有一组数据时的逻辑保持紧凑
    gridBottomPercent = 20;
    const activeLegends = buLegends.length > 0 ? buLegends : tdLegends;
    const activeLabel = buLegends.length > 0 ? 'Bottom-up:' : 'Top-down:';
    
    legendArray.push({
        data: activeLegends,
        bottom: '2%',
        left: leftPos,
        width: '85%'
    });
    titleArray.push({
        text: activeLabel,
        left: leftPos,
        bottom: '10%', // 只有一行时调低标题位置
        textStyle: { fontSize: 13, color: '#1e3a8a', fontWeight: 'bold' }
    });
}

// --- 3. 设置图表配置 ---
chart.setOption({
    color: myExtendedColors,
    title: titleArray,
    legend: legendArray,
    // 动态调整 grid.bottom，防止图表压到图例
    grid: { 
        left: '5%', 
        right: '5%', 
        top: 80,
        bottom: gridBottomPercent + '%', 
        containLabel: true 
    },
    tooltip: {
        trigger: "axis",
        formatter: function(params) {
            let res = `<b>Year: ${params[0].name}</b><br/>`;
            let hasValid = false;
            params.forEach(p => {
                if (p.seriesType === 'line' && p.data && p.data.value !== null) {
                    const d = p.data;
                    const errInfo = (d.errPos || d.errNeg) 
                        ? `<span style="font-size:0.9em; color:#666;"> (+${d.errPos}/-${d.errNeg})</span>` 
                        : "";
                    res += `${p.marker} ${p.seriesName}: <b>${d.value}</b>${errInfo}<br/>`;
                    hasValid = true;
                }
            });
            return hasValid ? res : null;
        }
    },
    xAxis: {
    type: "category",
    data: yearRange,
    // --- 核心修改：对齐逻辑 ---
    boundaryGap: true, // 1. 让折线图的点直接落在刻度线上，而不是两个刻度中间
    axisTick: {
        alignWithLabel: true // 2. 确保刻度线与文字标签中心对齐
    },
    axisLabel: {
        interval: 'auto', // 自动计算密度，防止年份太多挤在一起
        rotate: yearRange.length > 10 ? 45 : 0, // 年份多时旋转
        hideOverlap: true, // 自动隐藏重叠的标签
        margin: 12 // 文字与轴线的间距
    },
    axisLine: {
        onZero: false // 确保轴线在最底部
    }
},
    yAxis: {
        type: "value",
        name: "Gg yr⁻¹",
        min: 0,
        max: smartMax, 
        interval: smartInterval,
        splitLine: { lineStyle: { type: 'dashed' } },
        axisTick: { show: true },
        axisLine: { show: true },
        axisLabel: {
            formatter: function(value) {
                return Number.isInteger(value) ? value.toString() : value.toFixed(1);
            }
        }
    },
    series: series
});
}

/**
 * 辅助函数：更新页面下方的参考文献表格
 * 修复了字段错位、Year不显示、Reference不显示的问题
 */
function updateComparisonReferenceTable(data) {
    const tableBody = document.getElementById("comp-table-body");
    if (!tableBody) return;

    tableBody.innerHTML = "";

    if (!data || data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-400">No references available.</td></tr>`;
        return;
    }

    const groups = {};

    data.forEach(item => {
        // 兼容性字段提取：解决大小写不一致导致的读取失败
        const name = item.dataset || item.study || item.Name || "Unknown";
        const substance = item.substance || item.Substance || item.gas || "N/A";
        const region = item.region || item.Region || "Global";
        const method = item.method;
        const citation = item.citation || item.Citation || item.reference || "Reference not provided";
        const rawYear = item.year || item.Year;

        // 以 Study+物质+区域 作为分组基准，合并不同年份
        const groupKey = `${name}|${substance}|${region}`;
        
        if (!groups[groupKey]) {
            groups[groupKey] = {
                name: name,
                substance: substance,
                region: region,
                method: method,
                years: [],
                citation: citation
            };
        }

        if (rawYear) {
            const parsedYear = parseInt(rawYear);
            if (!isNaN(parsedYear)) groups[groupKey].years.push(parsedYear);
        }
    });

    const summaryData = Object.values(groups).map(group => {
        let yearRange = "N/A";
        if (group.years.length > 0) {
            const minYear = Math.min(...group.years);
            const maxYear = Math.max(...group.years);
            yearRange = minYear === maxYear ? `${minYear}` : `${minYear}–${maxYear}`;
        }
        return { ...group, yearRange };
    });

    summaryData.sort((a, b) => a.name.localeCompare(b.name));

    // 严格按照 HTML <thead> 顺序渲染：Study, Substance, Region, Year, Method, Reference
    summaryData.forEach(row => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50 transition-colors border-b border-gray-100";
        
        tr.innerHTML = `
            <td class="px-6 py-4 font-semibold text-blue-900">${row.name}</td>
            <td class="px-6 py-4 text-gray-700">${row.substance}</td>
            <td class="px-6 py-4 text-gray-700">${row.region}</td>
            <td class="px-6 py-4 text-gray-500 font-medium">${row.yearRange}</td>
            <td class="px-6 py-4 text-gray-700">${row.method}</td>
            <td class="px-6 py-4 italic text-gray-600 text-sm" style="max-width: 400px; overflow-wrap: break-word;">${row.citation}</td>
        `;
        tableBody.appendChild(tr);
    });
}

    // 8. Auth & Downloads (Simulated)
    function openAuthModal() { document.getElementById('auth-modal').classList.remove('hidden'); }
    function closeAuthModal() { document.getElementById('auth-modal').classList.add('hidden'); }
    function toggleAuthMode() {
        authMode = authMode === 'login' ? 'register' : 'login';
        document.getElementById('register-fields').classList.toggle('hidden');
        document.getElementById('auth-title').innerText = authMode === 'login' ? 'Login' : 'Register';
        document.getElementById('toggle-btn').innerText = authMode === 'login' ? 'Switch to Register' : 'Switch to Login';
   }

    function submitAuth() {
        // GitHub Pages Simulation: Just set true
        isLoggedIn = true;
        const email = document.getElementById('auth-email').value || "user@demo.com";
        document.getElementById('user-status').innerHTML = `<span class="text-sm font-semibold">Welcome, ${email}</span>`;
        closeAuthModal();
        alert("Login Successful (Demo Mode)");
    }

   function handleDownload(filename) {
    // 弹出提示框，要求联系指定邮箱
    alert("Please contact us at fangxuekun@zju.edu.cn to obtain the data.");
}

    </script>
</body>
</html>